{% extends 'templ.html' %}

{% block title %}Hoodlem - Superintendent Updog News{% endblock %}

{% block content %}
<main class="flex-grow container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-playfair font-bold mb-6 text-gray-800">Hoodlem Chat</h2>
            <div class="h-96 overflow-y-auto mb-4 space-y-4" id="chat-box">
            </div>
            <div class="border-t pt-4">
                <div class="flex gap-4">
                    <input type="text" 
                           id="input-box" 
                           class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Type your message...">
                    <button onclick="sendData()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors duration-200">
                        Send
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-2">Please keep conversations respectful and on-topic</p>
            </div>
        </div>
    </div>
</main>
<script src=https://code.jquery.com/jquery-3.7.1.js></script>
<script>
    const inputBox = document.getElementById("input-box");
    const chatBox = document.getElementById("chat-box");

    async function sendData() {
        const userMessage = inputBox.value.trim();
        inputBox.value = '';
        if (!userMessage) return;

        // Add user's message to chat
        chatBox.innerHTML += `
            <div class="flex justify-end">
                <div class="bg-blue-100 rounded-lg p-3 max-w-xs lg:max-w-md">
                    <p class="text-gray-800">${userMessage}</p>
                    <span class="text-xs text-gray-500 mt-1 block">Just now</span>
                </div>
            </div>
        `;

		// Next AI message
		const aiMessageBox = document.createElement('div');
		aiMessageBox.className = 'flex justify-start';
		aiMessageBox.innerHTML = '';

        // Add typing indicator
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'flex justify-start';
        typingIndicator.id = 'typing-indicator';
        typingIndicator.innerHTML = `
            <div class="bg-gray-100 rounded-lg p-3 max-w-xs lg:max-w-md animate-pulse">
                <p class="text-gray-500 italic">Yo I'm typin dawg...</p>
            </div>
        `;
        chatBox.appendChild(typingIndicator);
        chatBox.scrollTop = chatBox.scrollHeight;

        const data = { message: userMessage };

        try {
            const response = await fetch('{{ url_for("chat.chat_stream") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Network response was not ok');

			const reader = await response.body.getReader();
			const decoder = new TextDecoder();
            //const result = await response.json();

            // Remove typing indicator
            typingIndicator.remove();

			chatBox.appendChild(aiMessageBox);

			while (true) {
				const { value, done } = await reader.read();
				if (done) break;
				const chunk = decoder.decode(value, { stream: true });
				aiMessageBox.innerHTML = `
                    <div class="bg-gray-100 rounded-lg p-3 max-w-xs lg:max-w-md">
                        <p class="text-gray-800">${chunk}</p>
                        <span class="text-xs text-gray-500 mt-1 block">Just now</span>
                    </div>
				`
			}

            chatBox.scrollTop = chatBox.scrollHeight;

        } catch (error) {
            typingIndicator.remove();
            console.error('Error:', error);
            chatBox.innerHTML += `
                <div class="text-red-500 text-sm">
                    Yo I'm havin technical difficulties dawg :(
                </div>
            `;
        }
    }

    inputBox.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendData();
    });
</script>
{% endblock %}
